@model WebSImus.Models.ConsultaPublicaFestivalesViewModel
@{
    Layout = null;
    ViewBag.Title = "Consulta de festivales";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title - SIMUS</title>
    <link rel="icon" href="~/img/favicon.ico" type="image/x-icon" />
    
    @* Estilos del proyecto *@
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <link href="~/css/fontawesome/font-awesome.css" rel="stylesheet" />
    <link href="~/css/festivales.css" rel="stylesheet" />
    
    @* Estilos personalizados para consulta pública *@
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito Sans', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .consulta-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Encabezado con diseño del proyecto */
        .header-consulta {
            background-color: #281e52;
            color: white;
            padding: 40px 30px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
        }

        .header-consulta h1 {
            font-size: 2.4rem;
            font-weight: bold;
            margin: 0;
        }

        .header-consulta i {
            margin-right: 10px;
        }

        /* Panel de filtros */
        .filtros-panel {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .filtros-titulo {
            color: #281e52;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #281e52;
        }

        .filtros-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filtro-group {
            flex: 1;
            min-width: 200px;
        }

        .filtro-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .filtro-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filtro-input:focus {
            outline: none;
            border-color: #281e52;
            box-shadow: none;
        }

        .filtros-acciones {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-buscar {
            background: #281e52;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease;
        }

        .btn-buscar:hover {
            background: #3e2e75;
        }

        /* Sección de filtros laterales */
        .contenido-principal {
            display: flex;
            gap: 25px;
        }

        .filtros-laterales {
            flex: 0 0 280px;
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
            height: fit-content;
        }

        .filtros-laterales h3 {
            color: #281e52;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #281e52;
        }

        .filtro-seccion {
            margin-bottom: 20px;
        }

        .filtro-seccion-titulo {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 13px;
            color: #555;
            cursor: pointer;
            margin: 0;
        }

        /* Área de resultados con tarjetas de festivales */
        .resultados-area {
            flex: 1;
        }

        .boton-mapa {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
        }

        .boton-mapa:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .resultados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Tarjeta de festival según el diseño */
        .festival-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.07);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .festival-card:hover {
            transform: translateY(-5px);
        }

        .festival-imagen {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            position: relative;
            overflow: hidden;
        }

        .festival-imagen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Imagen por defecto con cielo y sol */
        .festival-imagen-default {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 60%, #90EE90 60%, #90EE90 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .festival-sol {
            width: 60px;
            height: 60px;
            background: #FFD700;
            border-radius: 50%;
            position: absolute;
            top: 30px;
            right: 40px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .festival-nubes {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .nube {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.9;
        }

        .nube1 {
            width: 80px;
            height: 30px;
            top: 40px;
            left: 30px;
        }

        .nube1::before,
        .nube1::after {
            content: '';
            position: absolute;
            background: white;
            border-radius: 50%;
        }

        .nube1::before {
            width: 35px;
            height: 35px;
            top: -15px;
            left: 10px;
        }

        .nube1::after {
            width: 40px;
            height: 40px;
            top: -18px;
            left: 35px;
        }

        .festival-info {
            padding: 20px;
        }

        .festival-nombre {
            font-size: 1.2rem;
            font-weight: bold;
            color: #281e52;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .festival-detalles {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
        }

        .festival-detalle-item {
            margin-bottom: 5px;
        }

        .festival-ubicacion {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #555;
            margin-top: 10px;
        }

        /* Mensaje sin resultados */
        .sin-resultados {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sin-resultados i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .sin-resultados h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .sin-resultados p {
            font-size: 14px;
            color: #999;
        }

        /* Responsive */
        @@media (max-width: 992px) {
            .contenido-principal {
                flex-direction: column;
            }

            .filtros-laterales {
                flex: 1;
            }

            .resultados-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @@media (max-width: 768px) {
            .filtros-row {
                flex-direction: column;
            }

            .filtro-group {
                min-width: 100%;
            }

            .header-consulta h1 {
                font-size: 22px;
            }

            .resultados-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="consulta-container">
        <!-- Encabezado -->
        <div class="header-consulta">
            <h1>
                <i class="fas fa-music"></i>
                Festivales de M&uacute;sica en Colombia
            </h1>
        </div>

        <!-- Panel de filtros superiores -->
        <div class="filtros-panel">
            <h2 class="filtros-titulo">Si est&aacute; interesado/a en conocer la oferta de la regi&oacute;n por per&iacute;odo:</h2>
            
            <form id="formFiltros" method="get">
                <div class="filtros-row" style="margin-bottom: 10px;">
                    <div class="filtro-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="buscarPorMes" name="buscarPorMes" value="true" @(Model.BuscarPorMes ? "checked" : "") style="width: auto; margin: 0;" />
                        <label for="buscarPorMes" style="margin: 0; font-weight: normal; font-size: 13px;"></label>
                    </div>

                    <div class="filtro-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="buscarPorFecha" name="buscarPorFecha" value="true" @(Model.BuscarPorFecha ? "checked" : "") style="width: auto; margin: 0;" />
                        <label for="buscarPorFecha" style="margin: 0; font-weight: normal; font-size: 13px;"></label>
                    </div>

                    <div class="filtro-group">
                        <!-- Espacio vacío para mantener el grid -->
                    </div>
                </div>

                <div class="filtros-row">
                    <div class="filtro-group">
                        <label for="mesInicio">Mes:</label>
                        <input type="month" id="mesInicio" name="mesInicio" class="filtro-input" value="@Model.MesInicio" @(Model.BuscarPorMes ? "" : "disabled") />
                    </div>

                    <div class="filtro-group">
                        <label for="fechaInicio">Fecha Inicio:</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="filtro-input" value="@(Model.FechaInicio.HasValue ? Model.FechaInicio.Value.ToString("yyyy-MM-dd") : "")" @(Model.BuscarPorFecha ? "" : "disabled") />
                    </div>

                    <div class="filtro-group">
                        <label for="fechaFin">Fecha Fin:</label>
                        <input type="date" id="fechaFin" name="fechaFin" class="filtro-input" value="@(Model.FechaFin.HasValue ? Model.FechaFin.Value.ToString("yyyy-MM-dd") : "")" @(Model.BuscarPorFecha ? "" : "disabled") />
                    </div>
                </div>

                <div class="filtros-row">
                    <div class="filtro-group">
                        <label for="departamento">Departamento:</label>
                        <select id="departamento" name="departamento" class="filtro-input">
                            <option value="">Seleccionar</option>
                            @foreach (var depto in Model.Departamentos)
                            {
                                <option value="@depto.Codigo" @(Model.Departamento == depto.Codigo ? "selected" : "")>
                                    @depto.Nombre
                                </option>
                            }
                        </select>
                    </div>

                    <div class="filtro-group">
                        <label for="municipio">Municipio:</label>
                        <select id="municipio" name="municipio" class="filtro-input" @(string.IsNullOrEmpty(Model.Departamento) ? "disabled" : "")>
                            <option value="">Seleccionar</option>
                            @* Los municipios se cargan dinámicamente con AJAX *@
                        </select>
                    </div>
                </div>

                <div class="filtros-row">
                    <div class="filtro-group">
                        <label for="tipoIngreso">Tipo de ingreso:</label>
                        <select id="tipoIngreso" name="tipoIngreso" class="filtro-input">
                            <option value="">Seleccionar</option>
                            @foreach (var tipo in Model.TiposIngreso)
                            {
                                <option value="@tipo.Id" @(Model.TipoIngreso == tipo.Id.ToString() ? "selected" : "")>
                                    @tipo.Nombre
                                </option>
                            }
                        </select>
                    </div>

                    <div class="filtro-group">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo" class="filtro-input">
                            <option value="">Seleccionar</option>
                            @foreach (var tipologia in Model.Tipologias)
                            {
                                <option value="@tipologia.Id" @(Model.Tipo == tipologia.Id.ToString() ? "selected" : "")>
                                    @tipologia.Nombre
                                </option>
                            }
                        </select>
                    </div>

                    <div class="filtro-group">
                        <label for="buscar">Buscar:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="buscar" name="buscar" class="filtro-input" placeholder="Text with action" style="flex: 1;" value="@Model.TextoBusqueda" />
                            <button type="button" class="btn-buscar" style="padding: 8px 15px;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filtro-group" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                        <label style="margin: 0; white-space: nowrap;">Sin p&uacute;blico presencial (transmisi&oacute;n en vivo)</label>
                        <input type="checkbox" id="sinPublico" name="sinPublico" style="margin: 0;" />
                    </div>
                </div>

                <div class="filtros-acciones">
                    <button type="submit" class="btn-buscar">
                        <i class="fas fa-search"></i>
                        Buscar
                    </button>
                </div>
            </form>
        </div>

        <!-- Contenido principal con filtros laterales y resultados -->
        <div class="contenido-principal">
            <!-- Filtros laterales -->
            <aside class="filtros-laterales">
                <h3>Filtrar por:</h3>

                <!-- Territorios sonoros -->
                <div class="filtro-seccion">
                    <div class="filtro-seccion-titulo">Territorios sonoros:</div>
                    @if (Model.TerritoriosSonoros != null && Model.TerritoriosSonoros.Any())
                    {
                        foreach (var territorio in Model.TerritoriosSonoros)
                        {
                            <div class="checkbox-item">
                                <input type="checkbox" id="ts_@territorio.Id" name="territorios" value="@territorio.Id" />
                                <label for="ts_@territorio.Id">@territorio.Nombre</label>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="checkbox-item">
                            <input type="checkbox" id="ts1" name="territorios" value="1" />
                            <label for="ts1">TS Cantos, Pisos y Tamboreos</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ts2" name="territorios" value="2" />
                            <label for="ts2">TS Bambucos y Torbellin...</label>
                        </div>
                    }
                </div>

                <!-- Tipología -->
                <div class="filtro-seccion">
                    <div class="filtro-seccion-titulo">Tipolog&iacute;a:</div>
                    @if (Model.Tipologias != null && Model.Tipologias.Any())
                    {
                        foreach (var tipologia in Model.Tipologias)
                        {
                            <div class="checkbox-item">
                                <input type="checkbox" id="tip_@tipologia.Id" name="tipologias" value="@tipologia.Id" />
                                <label for="tip_@tipologia.Id">@tipologia.Nombre</label>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="checkbox-item">
                            <input type="checkbox" id="tip1" name="tipologia" value="1" />
                            <label for="tip1">Encuentro</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tip2" name="tipologia" value="2" />
                            <label for="tip2">Feria</label>
                        </div>
                    }
                </div>

                <!-- Tipo de expresión -->
                <div class="filtro-seccion">
                    <div class="filtro-seccion-titulo">Tipo de expresi&oacute;n:</div>
                    @if (Model.TiposExpresion != null && Model.TiposExpresion.Any())
                    {
                        foreach (var expresion in Model.TiposExpresion)
                        {
                            <div class="checkbox-item">
                                <input type="checkbox" id="exp_@expresion.Id" name="expresiones" value="@expresion.Id" />
                                <label for="exp_@expresion.Id">@expresion.Nombre</label>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="checkbox-item">
                            <input type="checkbox" id="exp1" name="expresion" value="1" />
                            <label for="exp1">Vocal</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="exp2" name="expresion" value="2" />
                            <label for="exp2">Bandas</label>
                        </div>
                    }
                </div>
            </aside>

            <!-- Área de resultados -->
            <div class="resultados-area">
                <!-- Botón Ver Mapa de festivales -->
                <button type="button" class="boton-mapa" onclick="window.location.href='@Url.Action("MapaPublico", "Festivales")'">
                    <i class="fas fa-map"></i>
                    Ver Mapa de festivales
                </button>

                <!-- Grid de resultados -->
                <div class="resultados-grid" id="resultadosGrid">
                    @Html.Partial("_ResultadosConsultaPublica", Model)
                </div>

                <!-- Mensaje sin resultados (oculto por defecto, se muestra desde JS si es necesario) -->
                <div class="sin-resultados" style="display: none;" id="sinResultados">
                    <i class="fas fa-search"></i>
                    <h3>No se encontraron festivales</h3>
                    <p>Intenta ajustar los filtros de b&uacute;squeda</p>
                </div>
            </div>
        </div>
    </div>

    @* Modal de detalle del festival *@
    <div id="modalDetalleFestival" class="modal-festival" style="display: none;">
        <div class="modal-festival-content">
            <span class="modal-festival-close" onclick="cerrarModalFestival()">&times;</span>
            
            <div class="modal-festival-header">
                <div id="carouselFestival" class="carousel slide" data-bs-ride="carousel" style="display:none;">
                    <div class="carousel-inner" id="modalFestivalCarouselInner">
                        <!-- Items se agregan dinámicamente -->
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselFestival" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselFestival" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Siguiente</span>
                    </button>
                </div>
                <div id="modalFestivalImagenDefault" style="width: 100%; height: 200px; background: #eee; display: flex; align-items: center; justify-content: center; display: none;">
                    <i class="fas fa-music" style="font-size: 48px; color: #ccc;"></i>
                </div>
            </div>
            
            <div class="modal-festival-body">
                <h2 id="modalFestivalNombre" style="color: #281e52; margin-bottom: 5px;">Nombre Festival</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; font-size: 14px; color: #666;">
                    <span id="modalFestivalFechaInicio">Fecha inicio: dd/mm/aaaa</span>
                    <span id="modalFestivalFechaFin">Fecha final: dd/mm/aaaa</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span id="modalFestivalUbicacion" style="font-size: 14px; color: #666;">
                        <i class="fas fa-map-marker-alt"></i> Ubicaci&oacute;n
                    </span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: bold; color: #281e52; display: block; margin-bottom: 5px;">Descripci&oacute;n:</label>
                    <div id="modalFestivalDescripcion" style="padding: 10px; background: #f5f7fa; border-radius: 5px; min-height: 100px; color: #333;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <a href="#" id="modalFestivalTipologia" style="color: #00bcd4; text-decoration: none;">
                            <i class="fas fa-tag"></i> Tipolog&iacute;a
                        </a>
                    </div>
                    <div style="flex: 1;">
                        <a href="#" id="modalFestivalTipoExpresion" style="color: #00bcd4; text-decoration: none;">
                            <i class="fas fa-music"></i> Tipo de expresi&oacute;n
                        </a>
                    </div>
                </div>
                
                <h3 style="color: #281e52; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #281e52; padding-bottom: 5px;">
                    Informaci&oacute;n de contacto
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">Correo electr&oacute;nico de contacto:</label>
                        <input type="text" id="modalFestivalCorreo" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">Instagram:</label>
                        <input type="text" id="modalFestivalInstagram" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">Facebook:</label>
                        <input type="text" id="modalFestivalFacebook" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">P&aacute;gina WEB:</label>
                        <input type="text" id="modalFestivalWeb" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">Otro enlace:</label>
                        <input type="text" id="modalFestivalOtroEnlace" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                    <div>
                        <label style="color: #666; font-size: 13px; display: block; margin-bottom: 3px;">Tel&eacute;fono celular:</label>
                        <input type="text" id="modalFestivalTelefono" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;" placeholder="Especificar aqu&iacute;" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal-festival {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-festival-content {
            background-color: #fefefe;
            margin: 3% auto;
            border: 1px solid #888;
            width: 60%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-festival-close {
            color: #aaa;
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1050;
            background: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-festival-close:hover,
        .modal-festival-close:focus {
            color: #000;
        }

        .modal-festival-body {
            padding: 25px;
        }

        .modal-festival-header img, 
        .carousel-item img {
            border-radius: 10px 10px 0 0;
        }
    </style>

    @* Scripts *@
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <script src="~/Scripts/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Manejar checkboxes de búsqueda por mes/fecha
            $('#buscarPorMes').on('change', function() {
                var isChecked = $(this).is(':checked');
                $('#mesInicio').prop('disabled', !isChecked);
                
                if (isChecked) {
                    // Deshabilitar búsqueda por fecha
                    $('#buscarPorFecha').prop('checked', false);
                    $('#fechaInicio, #fechaFin').prop('disabled', true);
                }
            });

            $('#buscarPorFecha').on('change', function() {
                var isChecked = $(this).is(':checked');
                $('#fechaInicio, #fechaFin').prop('disabled', !isChecked);
                
                if (isChecked) {
                    // Deshabilitar búsqueda por mes
                    $('#buscarPorMes').prop('checked', false);
                    $('#mesInicio').prop('disabled', true);
                }
            });

            // Cargar municipios cuando haya un departamento seleccionado al cargar la página
            var deptoInicial = $('#departamento').val();
            if (deptoInicial) {
                cargarMunicipios(deptoInicial, '@Model.Municipio');
            }

            // Cargar municipios al cambiar departamento
            $('#departamento').on('change', function() {
                var departamento = $(this).val();
                var municipioSelect = $('#municipio');
                
                if (departamento) {
                    cargarMunicipios(departamento, null);
                } else {
                    municipioSelect.html('<option value="">Seleccionar</option>').prop('disabled', true);
                }
            });

            // Manejo del formulario de búsqueda
            $('#formFiltros').on('submit', function(e) {
                e.preventDefault();
                buscarFestivales();
            });
        });

        function cargarMunicipios(codigoDepartamento, municipioSeleccionado) {
            var municipioSelect = $('#municipio');
            municipioSelect.prop('disabled', true).html('<option value="">Cargando...</option>');
            
            $.ajax({
                url: '@Url.Action("ObtenerMunicipios", "Festivales")',
                type: 'GET',
                data: { codigoDepartamento: codigoDepartamento },
                success: function(data) {
                    var html = '<option value="">Seleccionar</option>';
                    
                    if (data && data.length > 0) {
                        $.each(data, function(index, municipio) {
                            var selected = municipioSeleccionado && municipio.codigo === municipioSeleccionado ? ' selected' : '';
                            html += '<option value="' + municipio.codigo + '"' + selected + '>' + municipio.nombre + '</option>';
                        });
                    }
                    
                    municipioSelect.html(html).prop('disabled', false);
                },
                error: function() {
                    municipioSelect.html('<option value="">Error al cargar</option>').prop('disabled', false);
                    console.error('Error al cargar municipios');
                }
            });
        }

        function buscarFestivales() {
            console.log('Buscando festivales...');
            
            // Mostrar loading
            $('#resultadosGrid').html('<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-3x" style="color: #2c9c94;"></i></div>');
            
            // Collect form data
            var params = $('#formFiltros').serializeArray();
            
            // Collect side filters
            var territorios = [];
            $('input[name="territorios"]:checked').each(function() {
                territorios.push($(this).val());
            });
            if (territorios.length > 0) {
                params.push({ name: 'territorios', value: territorios.join(',') });
            }
            
            var tipologias = [];
            $('input[name="tipologias"]:checked').each(function() {
                tipologias.push($(this).val());
            });
            if (tipologias.length > 0) {
                params.push({ name: 'tipologias', value: tipologias.join(',') });
            }
            
            var expresiones = [];
            $('input[name="expresiones"]:checked').each(function() {
                expresiones.push($(this).val());
            });
            if (expresiones.length > 0) {
                params.push({ name: 'expresiones', value: expresiones.join(',') });
            }

            $.ajax({
                url: '@Url.Action("BuscarFestivalesAjax", "Festivales")',
                type: 'GET',
                data: params,
                success: function(data) {
                    $('#resultadosGrid').html(data);
                },
                error: function() {
                    $('#resultadosGrid').html('<div class="sin-resultados"><i class="fas fa-exclamation-triangle"></i><h3>Error al buscar</h3><p>Ocurri&oacute; un error al realizar la b&uacute;squeda.</p></div>');
                }
            });
        }

        function verDetalleFestival(festivalId) {
            console.log('Abriendo detalle de festival con festivalId:', festivalId);
            console.log('Tipo de festivalId:', typeof festivalId);
            
            // Limpiar contenido previo para evitar que se vea la información del festival anterior
            $('#modalFestivalNombre').text('Cargando...');
            $('#modalFestivalFechaInicio').text('');
            $('#modalFestivalFechaFin').text('');
            $('#modalFestivalUbicacion').html('');
            $('#modalFestivalDescripcion').text('');
            $('#modalFestivalTipologia').html('');
            $('#modalFestivalTipoExpresion').html('');
            
            // Limpiar inputs de contacto
            $('#modalFestivalCorreo').val('');
            $('#modalFestivalInstagram').val('');
            $('#modalFestivalFacebook').val('');
            $('#modalFestivalWeb').val('');
            $('#modalFestivalOtroEnlace').val('');
            $('#modalFestivalTelefono').val('');
            
            // Limpiar carrusel e imágenes
            $('#carouselFestival').hide();
            $('#modalFestivalCarouselInner').empty();
            $('#modalFestivalImagenDefault').show();

            // Mostrar modal
            $('#modalDetalleFestival').show();
            
            // Obtener detalle del festival por AJAX
            $.ajax({
                url: '@Url.Action("ObtenerDetalleFestival", "Festivales")',
                type: 'GET',
                data: { festivalId: festivalId },
                success: function(data) {
                    console.log('Respuesta del servidor:', data);
                    console.log('Datos del festival:', {
                        nombre: data.nombre,
                        fechaInicio: data.fechaInicio,
                        fechaFin: data.fechaFin,
                        ubicacion: data.ubicacion,
                        descripcion: data.descripcion,
                        imagenUrl: data.imagenUrl,
                        tipologia: data.tipologia,
                        expresionesArtisticas: data.expresionesArtisticas,
                        correo: data.correo,
                        instagram: data.instagram,
                        facebook: data.facebook,
                        paginaWeb: data.paginaWeb,
                        otroEnlace: data.otroEnlace,
                        telefono: data.telefono
                    });
                    
                    if (data.error) {
                        alert('Error: ' + data.error);
                        $('#modalDetalleFestival').hide();
                        return;
                    }
                    
                    // Llenar los datos del modal
                    $('#modalFestivalNombre').text(data.nombre || 'Nombre Festival');
                    
                    // Formatear fechas
                    var fechaInicio = data.fechaInicio ? formatearFecha(data.fechaInicio) : 'dd/mm/aaaa';
                    var fechaFin = data.fechaFin ? formatearFecha(data.fechaFin) : 'dd/mm/aaaa';
                    $('#modalFestivalFechaInicio').text('Fecha inicio: ' + fechaInicio);
                    $('#modalFestivalFechaFin').text('Fecha final: ' + fechaFin);
                    
                    $('#modalFestivalUbicacion').html('<i class="fas fa-map-marker-alt"></i> ' + (data.ubicacion || 'Ubicaci&oacute;n'));
                    $('#modalFestivalDescripcion').text(data.descripcion || 'Sin descripci&oacute;n');
                    
                    // Carrusel de imágenes
                    var carouselInner = $('#modalFestivalCarouselInner');
                    carouselInner.empty();
                    
                    if (data.imagenes && data.imagenes.length > 0) {
                        $('#carouselFestival').show();
                        $('#modalFestivalImagenDefault').hide();
                        
                        $.each(data.imagenes, function(index, url) {
                            var activeClass = index === 0 ? ' active' : '';
                            var itemHtml = '<div class="carousel-item' + activeClass + '">';
                            itemHtml += '<img src="' + url + '" class="d-block w-100" style="height: 300px; object-fit: cover;" alt="Imagen festival">';
                            itemHtml += '</div>';
                            carouselInner.append(itemHtml);
                        });
                        
                        // Mostrar/ocultar controles según cantidad
                        if (data.imagenes.length > 1) {
                            $('.carousel-control-prev, .carousel-control-next').show();
                        } else {
                            $('.carousel-control-prev, .carousel-control-next').hide();
                        }
                    } else {
                        $('#carouselFestival').hide();
                        $('#modalFestivalImagenDefault').show();
                    }
                    
                    // Tipología y expresión
                    $('#modalFestivalTipologia').html('<i class="fas fa-tag"></i> ' + (data.tipologia || 'Tipolog&iacute;a'));
                    $('#modalFestivalTipoExpresion').html('<i class="fas fa-music"></i> ' + (data.expresionesArtisticas || 'Tipo de expresi&oacute;n'));
                    
                    // Información de contacto
                    $('#modalFestivalCorreo').val(data.correo || '');
                    $('#modalFestivalInstagram').val(data.instagram || '');
                    $('#modalFestivalFacebook').val(data.facebook || '');
                    $('#modalFestivalWeb').val(data.paginaWeb || '');
                    $('#modalFestivalOtroEnlace').val(data.otroEnlace || '');
                    $('#modalFestivalTelefono').val(data.telefono || '');
                },
                error: function() {
                    alert('Error al cargar el detalle del festival');
                    $('#modalDetalleFestival').hide();
                }
            });
        }

        function cerrarModalFestival() {
            $('#modalDetalleFestival').hide();
        }

        // Formatear fecha en formato dd/mm/aaaa
        function formatearFecha(fecha) {
            if (!fecha) return '';
            
            // Si la fecha viene como string "dd/mm/aaaa", devolverla tal cual
            if (typeof fecha === 'string' && fecha.includes('/')) {
                return fecha;
            }
            
            // Si viene como objeto Date o string ISO, formatear
            var date = new Date(fecha);
            if (isNaN(date.getTime())) return fecha; // Si no es válida, devolver original
            
            var dia = ('0' + date.getDate()).slice(-2);
            var mes = ('0' + (date.getMonth() + 1)).slice(-2);
            var anio = date.getFullYear();
            
            return dia + '/' + mes + '/' + anio;
        }

        // Cerrar modal al hacer clic fuera de él
        $(window).on('click', function(event) {
            if (event.target.id === 'modalDetalleFestival') {
                cerrarModalFestival();
            }
        });
    </script>
</body>
</html>
