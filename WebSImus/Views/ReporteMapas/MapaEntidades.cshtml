@{
    Layout = "~/Views/Shared/_LayoutPublico.cshtml";
}

<style type="text/css">
    #PanelMapa {
        height: 700px;
    }
</style>

<!-- Título sección -->
<div class="row">
    <div class="col-md-12">
        <div class="col-md-1 col-sm-6 col-xs-6">
            <img style="padding-top:10px;" src="~/img/iconos/mapas_big.png" />
        </div>
        <div class="titulo_seccion col-md-11 col-sm-6 col-xs-6">MAPAS</div>
    </div>
</div>

<!-- Subtítulo -->
<div class="row">
    <div class="subtitulo_seccion col-md-6 col-sm-12 col-xs-12">
        <span class="fa-entidades fa-lg" style="text-align: left; padding: 5px;"></span>
        Entidades
    </div>
</div>

<!-- Contenedor filtros + mapa -->
<div class="col-md-12 well carousel-search">

    <!-- Filtros -->
    <div class="row" style="padding-top: 20px;">
        <div class="col-md-6">
            <form>
                <div class="btn-group">
                    @Html.DropDownList("DepartamentoSelector", (SelectList)ViewBag.departamentos, "Departamento", new { @class = "btn btn-default dropdown-toggle btn-select" })
                </div>
                <div class="btn-group">
                    @Html.DropDownList("MunicipioSelector", (SelectList)ViewBag.municipios, "Municipio", new { @class = "btn btn-default dropdown-toggle btn-select2" })
                </div>
                <div class="btn-group">
                    <button type="button" id="btnSearch" class="btn btn-primary">Volver a cargar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mapa -->
    <div class="row" style="margin-top: 20px;">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div id="PanelMapa" class="col-md-12">
                    <!-- Aquí se renderiza el mapa -->
                </div>
            </div>
        </div>
    </div>
</div>




@section Scripts {
    <script type="text/x-handlebars-template" id="infowin_entidades-template">
        <div id="infowin_escuelas">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="modal-header">
                    @*<div class="img-responsive">
                            <img src="../img/entidades.jpg" class="img-responsive" alt="entidades" />
                        </div>*@

                </div>
                <div class="titulo_entidad">
                    <div class="row">
                        <div class="col-md-12"> {{nombre}} </div>
                    </div>
                </div>

                <div class="row">
                    <div class="social-bar">
                        <div class="row">
                            <div class="fa-mapas fa-2x col-md-2"></div> <div class="col-md-10 social-txt">{{direccion}}, {{municipio}}, {{departamento}}    </div>
                        </div>

                        <div class="row">
                            <div class="fa-celular fa-2x col-md-2"></div> <div class="col-md-10 social-txt"> {{telefono}} </div>
                        </div>
                        <div class="row">
                            <div class="fa-correo fa-2x col-md-2"></div> <div class="col-md-10 social-txt">{{correoElectronico}}  </div>
                        </div>

                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-3 ">

                            <a href="{{ver_Mas}}" class="btn vermas_amarillo" target="_blank">Ver Mas</a>

                        </div>
                        <div class="col-md-offset-7">

                            <button type="button" class="btn btn-default" onclick="streetView('{{geometry.LATITUD}}', '{{geometry.LONGITUD}}')">Ver StreetView</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </script>
    <script type="text/javascript">
    // 1. Activar carga del mapa una vez cargue el DOM
    $(document).ready(function () {
        $(document).trigger('ON_COMPLETE_LOAD_COMPONENT');
    });

    // 2. Inicializar mapa con capa de entidades
    $(document).on('ON_COMPLETE_LOAD_COMPONENT', function () {
        window.componentMaps = new com.servinf[window.spaceName].ComponentMaps('#PanelMapa', {
            'module': com.servinf.ComponentMaps.Config.modules.VIEWER_DATA,
            'request_position': false,
            'search_bar': false,
            'streetview_panel': false,
            'map_type': "roadmap",
            'map_options': false,
            'initial_position': {
                'lat': 5.065781,
                'lng': -75.507820,
                'zoom': 6
            },
            'details': {
                '_initialPoint': {
                    'name': "Casa Museo Casa de Nariño",
                    'routing': true,
                    'streetview': false,
                    'Latitud': 4.599872,
                    'Longitud': -74.072898,
                    'templateString': "Este es el punto inicial"
                },
                'layers': [
                    {
                        'id': "entidades_mapa",
                        'name': "Entidades",
                        'type': "webservice",
                        'autoload': true,
                        'keyTitle': "nombre",
                        'fitBounds': false,
                        'cluster': true,
                        'cluster_options': {
                            'group_key': "nombre",
                            'primary_key': "nombre",
                            'seconday_key': "direccion"
                        },
                        'heat_map': false,
                        'heat_map_options': {
                            'max_zoom': 7
                        },
                        'url': "/Api/EntidadesGeo/",
                        'specifications': {
                            'node_list': "entidades"
                        },
                        'template_settings': {
                            'element': "infowin_entidades-template"
                        },
                        'methods': {
                            'onFetchData': function (data) {
                                console.log("Datos entidades:", data);
                            }
                        },
                        'thematic': [
                            {
                                'name': "entidades_simus",
                                'icon': "@Url.Content("~/img/marcadores/marker_entidad.png")",
                                'rule': {
                                    'key': "",
                                    'operator': "*",
                                    'value': ""
                                }
                            }
                        ]
                    }
                ]
            }
        });
    });

    // 3. Filtros de Departamento y Municipio
    $(function () {
        $('#DepartamentoSelector').change(function () {
            var selectedDep = $(this).val();
            var city = $('#MunicipioSelector');

            if (selectedDep !== '') {
                $.getJSON('@Url.Action("GetMunicipio")', { departamento: selectedDep }, function (data) {
                    var items = '<option>Municipios </option>';
                    $.each(data, function (i, municipio) {
                        items += "<option value='" + municipio.value + "'>" + municipio.text + "</option>";
                    });
                    city.empty().html(items).click();
                });

                const filter = [{ 'key': 'cod_Departamento', 'operator': 'equals', value: selectedDep }];
                componentMaps.getLayers()['entidades_mapa'].filter(filter);
            }
        });

        $('#MunicipioSelector').change(function () {
            var cod = $(this).val();
            const filter = [{ 'key': 'cod_Municipio', 'operator': 'equals', value: cod }];
            componentMaps.getLayers()['entidades_mapa'].filter(filter);
        });

        $('#btnSearch').click(function () {
            componentMaps.getLayers()['entidades_mapa'].filter();
            $("#DepartamentoSelector").val("").change();
            ActualizarMunicipios();
        });
    });

    function ActualizarMunicipios() {
        $('#MunicipioSelector').empty().html('<option>Municipios </option>').click();
    }
    </script>
}


