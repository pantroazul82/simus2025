@model WebSImus.Models.Institucionalidad
@{
    ViewBag.Title = ViewBag.NombreEscuela;
    Layout = "~/Views/Shared/_LayoutEstandar.cshtml";
}

@using (Html.BeginForm("Organizacion", "EscuelasMusica", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true, "", new { @class = "mf-validation-summary" })

    <nav aria-label="breadcrumb">
        <ol class="modern-breadcrumb">
            <li class="breadcrumb-item">@Html.ActionLink("Inicio", "Index", "Inicio", null, new { @class = "breadcrumb-link" })</li>
            <li class="breadcrumb-item">@Html.ActionLink("Escuelas", "Consulta", "EscuelasMusica", null, new { @class = "breadcrumb-link" })</li>
            <li class="breadcrumb-item">@Html.ActionLink("Exportar", "Exportar", "EscuelasMusica", new { Id = Model.EscuelaId }, new { @class = "breadcrumb-link" })</li>
            <li class="breadcrumb-item">@Html.ActionLink("Encuestas", "Formulario", "EscuelasMusica", new { Id = Model.EscuelaId }, new { @class = "breadcrumb-link" })</li>
            <li class="breadcrumb-item current" aria-current="page">
                <span class="breadcrumb-link">Organización</span>
            </li>
        </ol>
    </nav>

    <div class="modern-form-container">
        <div class="form-header">
            <h2 class="form-title">
                @ViewBag.NuevoTitulo
            </h2>
        </div>

        <div class="mb-6">
            @Html.Partial("_PasoAPaso")
        </div>

        @Html.HiddenFor(model => model.EscuelaId)
        @Html.Partial("_Institucionalidad", Model)

    </div>

    <div class="mf-alert mf-alert-success mf-alert-toast animated fadeIn" id="message-box-success" style="display:none;">
        <div class="mf-alert-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="mf-alert-content">
            <h5 class="mf-alert-title">Éxito</h5>
            <p>La información se actualizó con éxito.</p>
        </div>
        <button type="button" class="mf-alert-close mb-control-close" aria-label="Cerrar" onclick="$(this).closest('.mf-alert').fadeOut()">
            <i class="fas fa-times"></i>
        </button>
    </div>
}

@section Scripts {
    @Scripts.Render("~/Scripts/jqueryval")
    <script src="@Url.Content("~/Scripts/plugins/icheck/icheck.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/fileinput/fileinput.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/fileinput/fileinput_locale_es.js")"></script>
    <script src="~/Scripts/escuelasvalidate.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {

            $('#Regimen').change(function () {
                var selectedDep = $(this).val();
                var listadosubregimen = $('#SubRegimen');

                if (selectedDep != null && selectedDep != '') {
                    listadosubregimen.prop('disabled', true).html('<option>Cargando...</option>');
                    $.getJSON('@Url.Action("ConsultarSubRegimen")', { padre: selectedDep }, function (data) {
                        var items = '<option value="">Seleccione un valor</option>';
                        $.each(data, function (i, parametro) {
                            items += "<option value='" + parametro.value + "'>" + parametro.text + "</option>";
                        });
                        listadosubregimen.empty().html(items).prop('disabled', false);
                    }).fail(function() {
                        listadosubregimen.empty().html('<option value="">Error al cargar</option>').prop('disabled', false);
                        console.error("Error al cargar subregímenes.");
                    });
                } else {
                     listadosubregimen.empty().html('<option value="">Seleccione un Régimen primero</option>').prop('disabled', true);
                }
            }).trigger('change');

            if ($('#FechaNacimiento').val() == "0001-01-01" || $('#FechaNacimiento').val() == "1900-01-01") {
                $('#FechaNacimiento').val('');
            }

            var startDateDefault = new Date("01/31/1910");
            $('#FechaNacimiento').datepicker({
                startDate: startDateDefault,
                endDate: 'd',
                format: 'yyyy-mm-dd'
            });
            $('#FechaDocumentoCreacion').datepicker({
                startDate: startDateDefault,
                endDate: 'd',
                format: 'yyyy-mm-dd'
            });
        });


        var InformacionInstitucionalidad = ["#Primaria", "#Secundaria", "#Tecnico", "#UniversitariaSinTitulo", "#PregradoMusica", "#PregradoOtrasAreas", "#PostGrado", "#VoluntariosAdministrativo", "#ContratoLaboralAdministrativo", "#ContratoHonorariosAdministrativo", "#OrdenPrestacionServiciosAdministrativo"];
        var InformacionDocentesArray = ["#Voluntarios", "#ContratoLaboral", "#ContratoHonorario", "#OrdenPrestacionServicios"];

        $(InformacionDocentesArray.join(', ')).keypress(ValidaSoloNumeros);
        $(InformacionInstitucionalidad.join(', ')).keypress(ValidaSoloNumeros);

        if (typeof HabilitarDeshabilitarPasos === "function") {
            HabilitarDeshabilitarPasos();
        }
        $("#step3").addClass("active"); // Esta línea debe ser manejada por _PasoAPaso idealmente

        $("ul.paso-tabs > li").off('click').on('click', function () { // Asumiendo que _PasoAPaso usa ul.paso-tabs
            var step = $(this).data("step");
            var currentEscuelaId = @Model.EscuelaId;
            var baseUrl = "@Url.Action("ActionName", "ControllerName")".replace("ControllerName/ActionName", "");
            var action = "";
            var controller = "EscuelasMusica";
            var params = { id: currentEscuelaId };

            switch (step) {
                case 1: action = "EditarNuevo"; params.wizard = 1; break;
                case 2: action = "Beneficiarios"; break;
                case 3: action = "Organizacion"; break;
                case 4: action = "Formacion"; break;
                case 5: action = "Infraestructura"; break;
                case 6: case 61: action = "Produccion"; break;
                case 7:
                    controller = "FichaAsesoria";
                    action = "Asesoria";
                    break;
                default: return;
            }

            var finalUrl = baseUrl + controller + "/" + action;
            var queryString = $.param(params);
            if (queryString) {
                finalUrl += "?" + queryString;
            }
            window.location.href = finalUrl;
        });
    </script>
}